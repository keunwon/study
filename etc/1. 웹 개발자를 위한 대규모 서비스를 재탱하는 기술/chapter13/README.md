# 13. 다중성 확보, 시스템 안정화

## 33. 다중성 확보
### 다중성 확보 (AP 서버)
- AP 서버에서는 확장성을 생각하는 방식과 마찬가지로 서버 여러 대를 늘어놓는게 기본
    - 서버를 늘어놓을 때 중요한 것은 1대 2대 정도 정지하더라도 충분히 처리할 수 있도록 처리능력을 확보해두는 것
- 로드밸러스로 페일오버 (장애 극복), 페일 백 (정상 복귀)하여 고장 난 서버를 자동적으로 분리,  
서버가 복구되면 원상태로 복귀시키는 작업을 수행
### 다중성 확보 (DB 서버)
- DB 서버도 마찬가지로 서버를 여러 대 나열해서 1, 2대 정지하더라도 충분한 처리능력이 있도록 해두는 것이 중요
#### 멀티 마스터
- 페일오버에 대해 구체적인 동작을 설명하면, 상호간에 VRRP 프로토콜로 감시를 하고 있음
    - VRRP에 의해 한쪽이 분리된 것을 알게 되면 자신이 ACTIVE 마스터로 승격

## 34. 시스템 안정화
### 시스템 안정화를 위한 상반관계
- 한계에 다다를 정도로 사용하지 않고, 어느 ㅈ어도 버퍼를 유지하고 버퍼가 부족해지면 새로운 서버를 추가하거나 구성을 변경
- 전체적인 사용량을 줄여 안정성을 확보
### 시스템의 불안정 요인
#### 기능 추가, 메모리 누수
- 새로운 기능을 추가하면 그 기능이 예상보다 무거워서 전체적인 부하가 늘어나 서비스가 다운되는 일이 생김
- 메모리 누수도 상당히 불안정한 요인
#### 지뢰
- 특정 URL이 읽히면 아무리 시간이 지나도 응답이 오지 않아서 마치 지뢰처럼 장애의 원인이 되는 현상을 말함
#### 사용자의 액세스 패턴
- 사용자의 패턴 변화도 부하가 증대되는 원인
#### 데이터량 증가
- 예상했던 데이터량보다 늘어나서 이것이 전체적인 부하의 증가로 이어져서 시스템이 불안정해지는 경우
#### 외부연계 추가
- 광고 관련 웹 API나 Amazon 웹 API 등을 새롭게 추가하는 등 외부의 새로운 웹 API 연결하는 것을 말함
- 외부 연계를 늘리게 되면 외부 시스템이 다운되어 있을 때 덩달아서 다운되는 형태가 되기 쉬움
#### 메모리, HDD 장애, NIC 장애
- 메모리나 HDD, 네트워크 장애는 일상적으로 발생
- 하드웨어의 능력이 저하되더라도 문제가 되지 않도록 해두는 것도 중요
    - 로드밸런스에서 적절한 항목에 대해 헬스체크를 해서 하드웨어 장애로 이상이 생겼을 때 다른 서버로 요청

## 35. 시스템 안정화 대책
### 실제 안정화 대책 (적절한 버퍼 유지와 불안정 요인 제거)
- 안정화를 위한 사고장식에는 적절한 버퍼 유지와 불안정 요인의 제거가 필요
- 적절한 버퍼 유지를 위해 한계의 70% 운용을 수행
    - 상한선이 넘으면 서버를 추가하거나 메모리를 늘림
- 불안정 요인을 제거하는 것과 관련해서는 SQL 부하 대책, 메모리 누수 줄이기, 비정상 동작 시 자율제어
#### 이상 동작 시의 자율 제어
- 자동 DOS 판정
    - 자동 DOS 판정을 수행하도록 해서 1시간에 특정 IP주소로부터 다수의 요청이 오면, 당분간 403을 반환해서 자율적으로 차단함으로써 비정상 요청에 대처
- 자동 재시작
    - 메모리 누수로 인해 스왑을 사용하기 시작하면 부하가 증가하여 성능이 떨어짐
    - 어느 정도 리소스를 지나치게 사용했다라고 판단했다면 웹 서버를 재시작
- 자동 쿼리 제거
    - 소요시간이 긴 SQL을 KILL 함
- 자율제어는 잠정적인 해법이고 본질적인 해법이 아니라는 것을 염두해야 함
