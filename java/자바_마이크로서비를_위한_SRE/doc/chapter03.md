# 3. 관찰 가능성과 디버깅
- 관찰 가능성 신호가 지닌 가치에 따라 가용성에 기여하는 부류와 디버그 가능성을 높이는 부류로 나뉨
- 애플리케이션 메트릭은 가장 유용한 가용성 신호, 분산 추적과 로그는 디버깅 가능성 신호에 해당
## 3.1. 관찰 가능성의 세 주축과 두 분류
- 텔레메트리 데이터는 계속 쌓이므로 어떤 식으로든 용량을 줄이지 않으면 그에 따라 데이터 유지 비용도 증가 (유지할 수 있는 데이터의 양은 한계가 있으므로 데이터를 감소시키는 전략이 필요)
- 집계: 모든 측정 결과를 집계해 통계를 미리 계산함(타이머 데이터는 합계, 카운트, 제한적 분포 통계를 만들 수 있음)
- 샘플링: 일부 측정 결과만 선택적으로 유지
### 3.1.1 로그
- 로그의 양은 시스템 처리량에 비례
- 로그의 존재 의의는 명백히 디버깅에 있음
- 로그 데이터를 유지하고, 지속적으로 집계하고, 작업 페이로드를 할당하면 그에 상응하는 비용이 발생함
### 3.1.2. 분산 추적
- 원격 추적 로그는 실행(이벤트) 단위로 기록하지만 한편으로 시스템 각 부분에 일어나는 개별 이벤트를 인과적으로 연결하는 특성이 있음
### 3.1.3. 메트릭
- 메트릭은 개별적인 상호작용의 정보를 얻기보다는 주로 서비스 수준 지표를 이해하는 용도로 쓰이며 전체적으로 집계된 결과를 나타냄
## 3.2. 분산 추적 컴포넌트
- 스팬: 최종 사용자 요청을 만족시키는 각 접점의 성능 정보를 담음
- 추적은 요청의 엔드투엔드 성능에 대한 통찰을 얻고자 고안
## 3.3. 분산 추적 유횽
### 3.3.1. 수동 추적
- 집킨 브레이브, 오픈텔레메트리 라이브러리는 코드를 통해 명시적으로 애플리케이션을 측정하는 도구
### 3.3.2. 에이전트 추적
- 추적도 메트릭처럼 에이전트를 이용해 자동으로 추가할 수 있음
- 에이전트는 통상적으로 업체가 제공하며 코드를 고치지 않도록 바로 작동
- 에어전트는 애플리케이션과 전달 파이프라인에 탑재해야 하므로 복잡도를 증가 (유지 비용도 증가)
### 3.3.3. 프레임워크 추적
- 프레임워크는 자체적으로 텔레메트리를 지원
### 3.3.4. 서비스 메시 추적
- 서비스 메시는 애플리케이션 코드 외부에 존재하는 인프라 계층이며 마이크로서비스 사이의 상호작용을 관리 (이런 기능 중 상당수는 사이드카 프록시를 통해 애플리케이션 프로세스를 다루는 방식으로 구현)
- 서비스 메시를 추가하면 풍부한 측정 결과를 얻을 가능성이 높음, 비용과 자원도 당연히 추가로 필요 (RPC 호출보다 더 세밀한 개별 메서드 호출 수준까지 접근할 수 있기 때문)
- 서비스 메시 계층에서 애플리케이션을 측정할 때는 스프링 클라우스 슬루스 같은 프레임워크 측정 도구를 추가할 필요가 없음 (컨테이너 이미지를 변경, 수동 측정 코드를 추가할 필요 없음)
- 서비스 메시 측정보다 런타임 종속성 추가가 훨씬 더 쉽고 편리함 
## 3.4. 샘플링
- 추적 데이터 비용을 제어하려면 샘플링해야 함
- 뛰어난 샘플링 전략을 수립해도 일부 데이터는 폐기될 수밖에 없음
### 3.4.1. 전수 유지
- 모든 추적 데이터를 유지
- 일부조직은 이를 위해 엄청난 비용을 감수함
### 3.4.2. 비율 제한 샘플링
- 기본적으로 스프링 클라우드 슬루스는 매초 처음 10개 샘플을 유지하고 이후의 추적 데이터는 확률적으로 다운 샘플링 함 
- 적정 비율을 결정하는 가장 큰 요인은 비즈니스의 특성과 애플리케이션의 처리량
### 3.4.3. 확률 샘플링
- 확률 샘플링은 100개의  추적 데이터 중 몇 개를 유지할지를 결정
		- 비용: 확률로 샘플을 추출하면 추적 비용은 트래픽에 비례해 선형적으로 증가
		- 공극: 비율 기반 샘플링처럼 추적 ID와 헤더를 참조하지 않으므로 엔드투엔드 구성에 공극이 생김
### 3.4.4. 경계 샘플링
- 시스템과 처음 상호작용하는 경계에서 샘플 기준을 선정하고 다른 서비스와 컴포넌에 다운스트림을 따라 전파시켜 공극 문제를 해결

