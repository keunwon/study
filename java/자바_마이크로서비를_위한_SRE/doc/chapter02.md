# 2. 애플리케이션 메트릭
## 2.1. 블랙박스 vs 화이트 박스 모니터링
```
블랙박스
- 수집기가 입력과 출력을 관찰할 수 있지만 내부 작동 메커니즘은 알 수 없음
- 대표적으로 HTTP 요청과 응답
- 블랙박스 수집기는 프로세스를 가로채거나 감싸는 방식으로 대상을 측정

화이트박스
- 수집기가 입력과 출력에 더해 내부 작동 메커니즘을 관찰할 수 있음
- 화이트 박스 수집기는 애플리케이션 코드 내부에서 작동
```
- 서비스 메시 기반 측정 기법도 블랙박스 방식이며 일반적으로 에이전트보다 활용성이 낮음
## 2.2. 차원형 메트릭
- 하나의 메트릭명과 여러 키-값 태그로 구성된 스키마
## 2.3. 계층형 메트릭
- 차원형 메트릭 시스템이 대중화되기 전 많은 모니터링 시스템이 계층형 스키마를 사용
- 키-값 태그 쌍 없이 이름으로만 메트릭을 정의하는 구조
## 2.6. 메트릭명
- 메트릭명은 영소문자 단어들로 구성하며 마침표로 구분 (마이크로 미터가 채택한 규칙)
- 서로 연관된 데이터를 묶을 때는 적절한 네임스페이스를 접두어로 사용하면 좋음
- 이름의 일부를 구분할 때는 항상 마침표를 사용
- 단위를 나타내는 단어 또는 total 등의 단어를 미터명에 추가하지 않음
- 일반적으로 고유한 값을 태그로 기록하지 않음 (고유한 총량이 아주 적은 경우는 제외)
### 2.6.1. 공통 태그
- 애플리케이션 이름, 클러스터와 서버 그룹명, 인스턴스 이름, 스택 (개발환경, 프로덕션 환경을 의미)
- 스프링 클라우드 컨피그 서버는 대표적인 동적 설정 서버
    - 배포 환경이 이러한 동작 설정 서버를 중심으로 구성된다면 공통 태그를 아주 쉽게 전달
## 2.7. 미터 클래스
- 메트릭 수집기는 다양한 미터 클래스를 제공하며 각 클래스는 하나 이상의 메트릭이나 통계를 발행
    - 게이지, 카운터, 타이머/요약 등이 대표적
    - 작기 작업 타이머, 시간 게이지, 간격 카운터 등 특수한 미터 클래스도 있음
## 2.8. 게이지
- 게이지는 시간의 흐름에 따라 증가 또는 감소하는 값을 순간적으로 측정한 값
- 컬렉션, 맵, 스레드 수 등은 통상적으로 애플리케이션이 실행되는 동안 게이지로 측정 (메모리, CPU 포함)
- 셀 수 있는 것은 절대 게이지로 측정하지 않음
- 'TimeGauge' 값은 게시되는 시점에 대상 모니터링 시스템의 기본 시간 단위로 변환
- 'MultiGauge' 늘어가거나 줄어드는 목록을 게이지로 측정하는 역할
    - 자주 쓰이는 경우는 SQL 쿼리처럼 경계가 뚜렷하지만 영역이 조금씩 변화는 데이터를 측정할 때
## 2.9. 카운터
- 카운터는 횟수를 보고하는 단일 메트릭 (고정된 수량을 측정하고 증가)
- 카운트가 사건을 측정하면 처리량이 측정
    - 사건이 발생하는 비율을 개념적으로 보면 처리량과 같음
## 2.10. 타이머
- 타이머는 단시간 동안 레이턴시를 측정하고 특정 이벤트의 빈도를 측정할 때 사용
- 카운터: 타이머가 기록하는 개별적인 측정 수치 (API 요청 건수를 나타냄)
- 합계: 모든 요청을 성곡적으로 응답하는 데 걸린 시간의 합
- 최댓값: 가장 오래 걸린 개별 시간 측정값이며, 주기가 반복될 때 갱신
### 2.10.1. '카운터'는 '처리량'을 의미
- 타이머의 카운트 통계는 자체적으로 쓸모가 있음 (처리량을 나타내는 지표)
- API 엔드포인트를 타이머로 측정하면 해당 엔드포인트를 요청한 횟수를, 대기열 메시지를 타이머로 측정하면 대기열에 배치된 메시지의 개수를 알수 있음
### 2.10.2. '카운터'와 '합계'를 조합하면 '집계 평균'을 의미
- 합계와 카운트를 함께 사용하면 집계 평균을 낼 수 있음
- 평균은 가용성 모니터링에 적합하지 않음
    - 평균은 모니터링 시스템의 다양성이 매우 높은 환경에서나 두루 사용하는 최소하는 통계
    - 가능하면 평균을 아예 사용하지 않는 것을 권함
- 가용성을 관찰할 때는 최댓값 또는 높은 백분위 통계가 더 유용
### 2.10.3. 최댓값 폐기와 푸시 간격
- 
### 2.10.4. 기간별 합계의 합계
- 합계의 합계를 유용하게 쓰는 경우는 거의 없음
### 2.10.5. 시간의 기본 단위
- 타이머에 적합한 기본 단위는 모니터링 시스템에 따라 다름
### 2.10.7. 레이턴시 분포의 일반적 특성
- 실행 시간은 대부분 다봉으로 분포
- 표준편차
    - 표준편차는 자바 실행 시간 측면에서 의미 있는 통계가 아님 (평균 동일)
### 2.10.8. 백분위/분위
- 평균 레이턴시는 모니터링 하기에는 모자란 지표
- 성능 비교 측면에서 보면 고백분위값이 더 무난함
- 중간값 또는 50번째 백분위수라 불리는 중위수는 최소에서 최대로 순위가 매겨진 샘플 집합의 중간을 가리킴
- 사용자가 일부 리소스에서 상위 1% 레이턴시를 경험할 가능성은 1%보다 훨씬 높음
    - 구하는 식: (1 - 0.99^n) * 100%
    - 마이크로서비스 체인에서 단일 요청이 상위 1% 레이턴시를 보이기 시작하면 이미 전체 사용자가 불편함을 겪는다는 뜻
- 라이브러리 코드에 타이머 추가하기
    - 라이브러리를 작성하고 시간 측정 코드를 추가할 때 타이머에 백분위수, 히스토그램, SLO 경계 등의 기능을 미리 구성하지 않는 것이 좋음
### 2.10.9. 히스토그램
- 히스토그램은 각 버킷(간격 또는 빈)에 담긴 개별 측정 시간 개수를 유지
- 버킷은 연속적이며 중첩되지 않음
### 2.10.10. 서비스 수준 목표 경계
- 서비스 수준 목표(SLO) 경계는 백분위나 히스토그램과 비슷하게 추가할 수 있음
- 많은 상황에서, 목표는 계층적으로 구성해야 합리성을 갖춤
## 2.11. 분포 요약
- 이벤트의 분포를 추적할 때 사용
- 구조적으로 타이머와 비슷하지만 시간 단위가 아닌 값을 기록 (ex. 서버가 만든 요청의 페이로드 크기)
## 2.12. 장기 작업 타이머
## 2.13. 미터 타입 선정
## 2.14. 비용 제어
## 2.15. 조율된 누락
## 2.16. 부하 테스트
## 2.17. 미터 필터
### 2.17.1. 미터 거부/허용
### 2.17.2. 메트릭 변형
### 2.17.3. 분포 통계 설정
## 2.18. 플랫폼과 애플리케이션 메트릭 분리
## 2.19. 모니터링 시스템에 따른 메트릭 분할
## 2.20. 미터 바인더
