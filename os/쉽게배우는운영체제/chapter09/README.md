# 9. 가상 메모리 관리

## 요구 페이징
### 요구 페이징 개요
- 사용자가 요구할 때 해당 페이지를 메모리로 가져오는 것을 **요구 페이징**이라고 함
- 미리 가져오기는 요구 페이징과 반대로 앞으로 필요할 것이라고 예상되는 페이지를 미리 가져오는 방식 (대표적으로 캐시)
- 현대 운영체제는 보통 요구 페이징을 기본으로 사용
### 페이지 테이블 엔트리의 구조
- 페이지 테이블 엔트리(PTE)는 페이지 테이블의 한 행을 말함
- PTE는 페이지 번호, 플래그 비트, 프레임 번호로 구성 (페이지 번호는 매핑 방식에 따라 포함여부가 결정, 직접 매핑에서는 필요가 없음)
- PTE의 마지막에 있는 프레임 번호는 가상 주소의 해당 페이지가 어느 프레임에 있는지 알려주는 자료 구조로 페이지 테이블의 핵심
- PTE 플래그 비트
    - 접근 비트(access-bit)
        - 페이지가 메모리에 올라온 후 사용한 적이 있는지 알려주는 비트 
        - 메모리에서 읽거나 실행 작업을 했다면 접근 비트는 1
        - 참조 비트라고도 함
    - 변경 비트(modified-bit)
        - 페이지가 메모리에 올라온 후 데이터의 변경이 있었는지 알려주는 비트
        - 메모리에서 쓰기나 추가 작업을 했다면 변경 비트는 1
        - 더티 비트라고도 함
    - 유효 비트(valid-bit)
        - 페이지가 실제 메모리에 있는지를 나타내는 비트
        - 페이지가 메모리에 있을때는 0, 스왑 영역에 있을때는 1
        - 현재 비트라고도 함
    - 읽기,쓰기,실행 비트 (read, write, excute)
        - 페이지에 대한 읽기, 쓰기, 실행 권한을 나타내는 비트
        - 접근 권한 비트라고도 함
        - 세그먼테이션-페이징 혼용 기법에서 테이블의 크기를 줄이기 위해 접근 권한 비트를 세그먼테이션 테이블로 옮김
### 페이지 부재
- 프로세스가 페이지를 요청했을 때 페이지가 메모리에 없는 상황을 페이지 부재라고 함
- 페이지 부재가 발생하면 메모리 관리자는 스왑 영역에서 해당 페이지를 메모리로 옮긴 후 작업을 진행
### 지역성
- 페이지 교체 알고리즘이 쫒아낼 페이지를 찾을 때는 지역성을 바탕으로 함
- 공간의 지역성: 현재 위치에서 가까운 데이터에 접근할 확률이 먼 거리에 있는 데이터에 접근할 확률보다 높음
- 시간의 지역성: 현재를 기준으로 가장 가까운 시간에 접근한 데이터가 더 먼 시간에 접근한 데이터보다 사용될 확률이 높음
- 순차적 지역성: 여러 작업이 순서대로 진행되는 경향이 있다는 것을 의미
- 캐시는 지역성에 대표적인 장치

## 페이지 교체 알고리즘
### 페이지 교체 알고리즘 개요
- 메모리 자원을 모두 사용한 상태에서 페이지 부재가 발생하면 메모리에 있는 페이지를 스왑 영역으로 내보내야 한다.  
이때 스왑 영역으로 보내는 페이지를 결정하는 알고리즘을 **페이지 교체 알고리즘**이라고 함
- 메모리에서 앞으로 사용할 가능성이 적은 페이지를 대상 페이지로 선정하여 페이지 부재를 줄이고 시스템 성능을 향상
### 무작위 페이지 교체 알고리즘
- 페이지 교체 알고리리즘 중 가장 간단하게 구현할 수 있는 방식
- 스왑 영역으로 쫒아낼 대상 페이지를 특별한 로직 없이 무작위로 선정하여 알고리즘 성능이 좋지 않아 거의 사용되지 않음
### FIFO 페이지 교체 알고리즘
- 시간상으로 메모리에 가장 먼저 들어온 페이지를 대상 페이지로 선정하여 스왑 영역으로 이동
- 무조건 오래된 페이지를 대상 페이지로 선정하기 때문에 성능이 떨어지는 문제점이 있음
### 최적 페이지 교체 알고리즘
- 앞으로 사용하지 않을 페이지를 스왑 영역으로 이동
- 미래의 접근 패턴을 안다는 것은 불가능하므로 실제로 구현할 수 없음
### 최적 근접 페이지 교체 알고리즘
- 과거의 데이터루부터 미래를 예측하기 때문에 최적 페이지 교체 알고리즘과 유사한 성능을 보임
#### LRU 페이지 교체 알고리즘
- 페이지에 접근한 시간을 기준으로 대상 페이지를 선정
- 메모리에 올라온 후 가장 오랫동안 사용되지 않은 페이지를 스왑 영역으로 옮김
- 시간을 기준으로 구현할 수 있으며 카운터나 참조 비트를 이용하는 방법도 있음
    - 시간
        - 페이지가 메모리에 올라오거나 사용될 때마다 그 시간(초)을 저장
        - 저장한 숫자가 작은 페이지가 오래된 페이지이므로 스왑 영역으로 이동
    - 카운터
        - 시간 기준에서 사용된 횟수로 변경
    - 참조 비트 시프트
        - 참조 비트 초깃값은 0이며 페이지에 접근할 때마다 1로 바뀌며 주기적으로 오른쪽으로 한 칸씩 이동함
        - 참조 비트 중 값이 작은 페이지를 대상 페이지로 선정하여 스왑 영역으로 이동
- LRU 페이지 교체 알고리즘은 접근 시간, 카운터, 참조 비트를 유지하기 위해서 메모리가 추가로 필요함
#### LFU 페이지 교체 알고리즘
- 페이지가 사용된 횟수를 기준으로 대상 페이지를 선정
- 현재 프레임에 있는 페이지마다 그동안 사용된 횟수를 세어 횟수가 가장 적은 페이지를 스왑 영역으로 이동
- LRU 페이지 교환 알고리즘과 마찬가지로 추가 메모리가 필요함
#### NUR 페이지 교체 알고리즘
- LRU, LFU 페이지 교체 알고리즘과 성능이 비슷하지만 메모리 공간 낭비 문제를 해결한 알고리즘
- NUR 페이지 교체 알고리즘에서는 참조 비트와 변경 비트 (2비트)를 가짐
    - 초기상태는 모두 0 (참조비트(PTE의 접근 비트), 변경비트(PTE의 변경 비트))
    - 참조 비트: 페이지에 접근하면 1 (읽기 또는 실행)
    - 변경 비트: 페이지가 변경되면 1 (쓰기 또는 추가)
- 대상 페이지 선정 순위
    1. (0, 0) 
    2. (0, 1)
    3. (1, 0)
    4. (1, 1)
- 모든 페이지의 비트가 (1, 1)인 경우 모드 (0, 0) 상태로 초기화
- LFU, LRU 페이지 교체 알고리즘에 비해 추가 메모리가 페이지 당 2bit뿐이여서 메모리 낭비를 줄이지만 비슷한 성능을 보임
- 구현하기 쉬워 가장 많이 사용함
### FIFO 변형 알고리즘
- FIFO 페이지 교체 알고리즘의 단점을 개선한 알고리즘
#### 2차 기회 페이지 교체 알고리즘
- 페이지 부재 없이 페이지에 접근을 하면 해당 페이지를 큐의 맨 뒤로 이동하여 대상 페이지에서 제외함
- FIFO 페이지 교체 알고리즘보다 조금 성능이 좋아지지만 큐를 유지하는 비용이 높고, 큐의 중간 값을 뒤로 이동하는 작업이 추가되는 것이 단점임
#### 시계 알고리즘
- 원형 큐를 사용하며 페이지에 참조 비트가 하나씩 추가됨
- 참조비트의 초기 값은 0이며 메모리에 있는 페이지를 성공적으로 참조하면 1로 변경
- 대상 페이지를 가리키는 포인터가 존재하며 만약 가리키는 페이지가 스왑 영역으로 이동하면 밑으로 이동을 한다.  
이동 후 페이지의 참조 비트가 1이면 건너뛰고 0으로 변경 함
- 페이지당 1bit만 추가하면 되기 때문에 NUR 페이지 교체 알고리즘보다 추가 메모리가 적게 들지만 알고리즘이 복잡하고 계산량이 많다는 단점이 있음

## 스레싱과 프레임 할당
### 스레싱 개념
- 하드디스크의 입출력이 너무 많아져서 잦은 페이지 부재로 작업이 멈춘 것 같은 상태를 스레싱이라고 함
### 스레싱과 프레임 할당
- 스레싱은 각 프로세스에 프레임을 할당하는 문제와도 연관이 있음
- 실행 중인 프로세스에 프레임을 얼마나 나누어주느냐에 따라 시스템의 성능이 달라짐
- 프레임을 나누어주는 정책에는 크게 정적 할당과 동적 할당으로 구분
### 정적 할당
- 정적 할당 방식은 프로세스 실행 초기에 프레임을 나누어준 후 그 크기를 고정하는 것으로 균등 할당 방식과 비례 할당 방식이 있음
- 균등 할당 방식
    - 프로세스의 크기와 상관없이 사용 가능한 프레임을 모든 프로세스에 동일하게 할당
    - 필요한 프레임을 할당받지 못하기 때문에 페이지 부재가 빈번하게 발생
- 비례 할당 방식
    - 프로세스 크기에 비례하여 프레임을 할당하는 방식
    - 프로세스가 실행 중에 필요로 하는 프레임을 유동적으로 반영하지 못함 (동영상 플레이어)
    - 사용하지 않을 메모리를 처음부터 미리 확보하여 공간을 낭비
### 동적 할당
- 시시각각 변하는 요청을 수용하는 방식
- 작업집합 모델 방식을 사용하는 방식과 페이지 부재 빈도를 사용하는 방식이 있음
- 작업집합 모델
    - 지역성 이론을 바탕으로, 최근 일정 시간 동안 참조된 페이지들을 집합으로 만들고 물리 메모리에 유지하여 프로세스 실행을 도움
    - 작업집합 크기: 작업 집합에 들어갈 최대 페이지 수
    - 잡업집합 윈도우: 작업집합에 포함되는 페이지의 범위
    - 잡업집합 윈도우 크기에 따라 프로세스 실행 성능이 달라짐
    - 작업집합 모델에서는 어떤 프레임을 물리 모메리에 유지해야 하는지는 알 수 있지만 프로세스에 프레임을 얼마나 할당해야하 하는지는 알 수 없음
- 페이지 부재 빈도
    - 페이지의 양을 동적으로 결정함
    - 페이지 부재 횟수를 기록하여 페이지 부재 비율을 계산함 (상한선, 하한선)
    - 페이지 부재 비율이 상한선을 초과하면 할당된 프레임이 적다는 것으로 의마하여 프레임을 늘림
    - 페이지 부재 비율이 하한선 밑으로 내려가면 메모리가 낭비된다는 의미로 프레임을 회수
    - 프로세스 처음 시작될 때는 예측하기가 어려움

## 프레임 관련 이슈
### 전역 교체와 지역 교체
- 페이지 교체 알고리즘에 따라 페이지를 교체 할때는 전역교체 방식 지역 교체 방식을 적용
- 전역 교체: 전체 프레임을 대상으로 교체 알고리즘 적용
- 지역 교체: 현재 실행 중인 프로세스의 프레임을 대상으로 교체 알고리즘 적용
    - 장점: 자신에게(process)에게 할당된 프레임의 전체 개수에 변화가 없이 페이지 교체를 하기 때문에 다른 프로세스에 영향도를 미치지 않음
    - 단점: 자주 사용하는 페이지가 스왑 영역으로 옮겨져 시스템의 효율이 떨어짐
- 전체 시스템의 입장에서는 전역 교체 방식이 지역 교체 방식보다 효율적
### 페이지 테이블 크기
- 페이지 테이블이 메모리에 있는 모든 프로세스에 하나씩 필요하다
- 페이지 테이블의 페이지 크기가 작으면 많은 용량이 필요하고, 크기를 크게 하면 내부 단편화로 인해 낭비
- 현대 컴퓨터 시스템은 물리 메모리도 커지고 응용 프로그램도 커짐에 따라 페이지의 크기도 점점 커지는 추세
### 쓰기 시점 복사(copy on write)
- 프로세스를 fork()로 복사 시 프로세의 변수가 존재하는데 새로 할당하지 않고 있다가 데이터가 변경되면 새로운 프레임에 내용이 복사됨 (데이터의 변화가 있을때까지 복사를 미루는 방식을 쓰기 시점 복사라고 함)
